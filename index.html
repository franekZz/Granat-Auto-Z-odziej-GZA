<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>GZA 1GB - Weapon Menu Update</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #ui { position: absolute; top: 20px; left: 20px; color: #ff00ff; text-shadow: 2px 2px #000; pointer-events: none; z-index: 10; }
        #mission-box { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.85); padding: 15px; border: 2px solid #ff00ff; color: #fff; width: 280px; border-radius: 5px; }
        #hp-bar-container { width: 200px; height: 12px; border: 1px solid #ff00ff; background: #300030; margin-top: 5px; }
        #hp-bar-fill { width: 100%; height: 100%; background: #ff00ff; transition: width 0.3s; }
        
        /* WEAPON MENU STYLE */
        #weapon-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none;
            justify-content: center; align-items: center; z-index: 200;
        }
        .menu-container { display: flex; gap: 20px; }
        .weapon-slot {
            width: 150px; height: 150px; background: rgba(255, 0, 255, 0.1);
            border: 3px solid #ff00ff; color: white; display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
            transition: 0.2s; border-radius: 15px; text-transform: uppercase; font-weight: bold;
        }
        .weapon-slot:hover { background: rgba(255, 0, 255, 0.4); transform: scale(1.1); }
        .locked { opacity: 0.3; cursor: not-allowed; border-color: #555; }

        #crosshair { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; border: 2px solid #00ff00; border-radius: 50%; transform: translate(-50%, -50%); display: none; pointer-events: none; }
        #instructions { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; background: rgba(0,0,0,0.9); z-index: 100; cursor: pointer; }
        #interaction-prompt { position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); color: #00ff00; font-size: 20px; display: none; font-weight: bold; text-shadow: 2px 2px black; }
    </style>
</head>
<body>

    <div id="ui">
        <div style="font-weight: bold; font-size: 24px;">GZA 1GB</div>
        <div id="hp-bar-container"><div id="hp-bar-fill"></div></div>
        <div id="weapon-info">BROÅƒ: PIÄ˜ÅšCI</div>
    </div>

    <div id="weapon-menu">
        <div class="menu-container">
            <div class="weapon-slot" onclick="selectWeapon('fists')">
                <div style="font-size: 40px;">ðŸ‘Š</div>
                <div>PiÄ™Å›ci</div>
            </div>
            <div id="gun-slot" class="weapon-slot locked" onclick="selectWeapon('gun')">
                <div style="font-size: 40px;">ðŸ”«</div>
                <div>Pistolet</div>
            </div>
        </div>
    </div>

    <div id="mission-box"><b>MISJA:</b> <br><span id="mission-text">IdÅº do bazy, by dostaÄ‡ sprzÄ™t.</span></div>
    <div id="crosshair"></div>
    <div id="interaction-prompt">NACIÅšNIJ [E] ABY DOSIÄ„ÅšÄ† ROWERU</div>

    <div id="instructions">
        <h1>GZA 1GB</h1>
        <p>KLIKNIJ, ABY ZACZÄ„Ä†</p>
        <p>TRZYMAJ [TAB] ABY ZMIENIÄ† BROÅƒ</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        let scene, camera, renderer, weapon, playerModel, bike;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, canJump = false;
        let velocity = new THREE.Vector3(), direction = new THREE.Vector3();
        let prevTime = performance.now();
        let npcs = [];
        let playerHP = 100, missionStep = 1, killedTargetsCount = 0;
        let isOnBike = false, cameraMode = 0, hasGun = false, currentWeapon = 'fists';
        let timeScale = 1;

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a000a);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const sun = new THREE.DirectionalLight(0xff00ff, 1);
            sun.position.set(100, 200, 100);
            scene.add(sun);

            // PodÅ‚oga
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(5000, 5000), new THREE.MeshPhongMaterial({ color: 0x111111 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Baza
            const building = new THREE.Mesh(new THREE.BoxGeometry(40, 40, 40), new THREE.MeshPhongMaterial({ color: 0x151515 }));
            building.position.set(0, 20, -100);
            scene.add(building);

            // Gracz
            playerModel = new THREE.Group();
            playerModel.add(new THREE.Mesh(new THREE.BoxGeometry(0.8, 2, 0.5), new THREE.MeshPhongMaterial({color: 0xff00ff})));
            scene.add(playerModel);

            // Model Pistoletu
            weapon = new THREE.Group();
            weapon.add(new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.12, 0.6), new THREE.MeshPhongMaterial({color: 0x333333})));
            weapon.position.set(0.3, -0.3, -0.7);
            weapon.visible = false;
            camera.add(weapon);
            scene.add(camera);

            // NPC i Cele
            createNPC(400, 400, true);
            createNPC(415, 385, true);

            // TAB Menu Logic
            document.addEventListener('keydown', (e) => {
                if(e.code === 'Tab') {
                    e.preventDefault();
                    document.getElementById('weapon-menu').style.display = 'flex';
                    document.exitPointerLock();
                    timeScale = 0.2; // Bullet time
                }
                if(e.code === 'KeyW') moveForward = true;
                if(e.code === 'KeyS') moveBackward = true;
                if(e.code === 'KeyA') moveLeft = true;
                if(e.code === 'KeyD') moveRight = true;
                if(e.code === 'KeyV') cameraMode = (cameraMode + 1) % 4;
                if(e.code === 'KeyE') handleBikeSelection();
            });

            document.addEventListener('keyup', (e) => {
                if(e.code === 'Tab') {
                    document.getElementById('weapon-menu').style.display = 'none';
                    document.body.requestPointerLock();
                    timeScale = 1;
                }
                if(e.code === 'KeyW') moveForward = false;
                if(e.code === 'KeyS') moveBackward = false;
                if(e.code === 'KeyA') moveLeft = false;
                if(e.code === 'KeyD') moveRight = false;
            });

            document.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement === document.body) {
                    playerModel.rotation.y -= e.movementX * 0.002;
                    camera.rotation.x -= e.movementY * 0.002;
                    camera.rotation.x = Math.max(-0.7, Math.min(0.7, camera.rotation.x));
                }
            });

            window.addEventListener('mousedown', () => {
                if (currentWeapon !== 'gun' || !hasGun || document.pointerLockElement !== document.body) return;
                
                weapon.position.z = -0.5;
                setTimeout(() => weapon.position.z = -0.7, 50);

                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera({x: 0, y: 0}, camera);
                const intersects = raycaster.intersectObjects(npcs, true);
                if (intersects.length > 0) {
                    let hit = intersects[0].object.parent;
                    if (hit.userData.hp > 0) {
                        hit.userData.hp -= 50;
                        if (hit.userData.hp <= 0) {
                            hit.rotation.z = Math.PI / 2;
                            if (hit.userData.isTarget) killedTargetsCount++;
                        }
                    }
                }
            });

            document.getElementById('instructions').onclick = () => {
                document.body.requestPointerLock();
                document.getElementById('instructions').style.display = 'none';
            };
        }

        function selectWeapon(type) {
            if (type === 'gun' && !hasGun) return;
            currentWeapon = type;
            document.getElementById('weapon-info').innerText = "BROÅƒ: " + (type === 'gun' ? "PISTOLET" : "PIÄ˜ÅšCI");
            // Ukrywamy menu po klikniÄ™ciu
            document.getElementById('weapon-menu').style.display = 'none';
            document.body.requestPointerLock();
            timeScale = 1;
        }

        function spawnMissionAssets() {
            bike = new THREE.Group();
            bike.add(new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.8, 1.8), new THREE.MeshPhongMaterial({color: 0x555555})));
            bike.position.set(0, 0.5, -100);
            scene.add(bike);
            
            hasGun = true;
            document.getElementById('gun-slot').classList.remove('locked');
        }

        function createNPC(x, z, isTarget) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.2, 1), new THREE.MeshPhongMaterial({color: isTarget?0xff0000:0x00ff88}));
            group.add(body);
            group.position.set(x, 1.1, z);
            group.userData = { hp: 100, aggro: isTarget, lastShot: 0, isTarget: isTarget };
            scene.add(group);
            npcs.push(group);
        }

        function handleBikeSelection() {
            if (bike && playerModel.position.distanceTo(bike.position) < 6) {
                isOnBike = !isOnBike;
                if(isOnBike && missionStep === 2) {
                    missionStep = 3;
                    document.getElementById('mission-text').innerText = "JedÅº do ZÅ‚ej Dzielnicy (400, 400).";
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = ((time - prevTime) / 1000) * timeScale;

            if (missionStep === 1 && playerModel.position.distanceTo(new THREE.Vector3(0, 0, -100)) < 15) {
                spawnMissionAssets();
                missionStep = 2;
                document.getElementById('mission-text').innerText = "Wybierz pistolet [TAB] i wsiÄ…dÅº na rower [E].";
            }

            if (missionStep === 3 && playerModel.position.distanceTo(new THREE.Vector3(400, 0, 400)) < 60) missionStep = 4;
            if (missionStep === 4) {
                document.getElementById('mission-text').innerText = "Zabij cele: " + killedTargetsCount + "/2";
                if(killedTargetsCount >= 2) document.getElementById('mission-text').innerText = "MISJA WYKONANA!";
            }

            let moveSpeed = isOnBike ? 1000 : 400;
            velocity.y -= 9.8 * 4.0 * delta;
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;
            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            if (moveForward || moveBackward) velocity.z -= direction.z * moveSpeed * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * moveSpeed * delta;

            playerModel.position.add(new THREE.Vector3(-velocity.x * delta, 0, velocity.z * delta).applyQuaternion(playerModel.quaternion));
            playerModel.position.y += velocity.y * delta;
            if (playerModel.position.y < 1.1) { velocity.y = 0; playerModel.position.y = 1.1; canJump = true; }

            if(isOnBike) { bike.position.copy(playerModel.position); bike.rotation.y = playerModel.rotation.y; }

            // Camera / Weapon Visibility
            if (cameraMode === 0) {
                camera.position.copy(playerModel.position).y += 0.8;
                camera.rotation.y = playerModel.rotation.y;
                playerModel.visible = false;
                weapon.visible = (hasGun && currentWeapon === 'gun');
                document.getElementById('crosshair').style.display = weapon.visible ? 'block' : 'none';
            } else {
                playerModel.visible = true; weapon.visible = false;
                document.getElementById('crosshair').style.display = 'none';
                if (cameraMode === 1) camera.position.copy(playerModel.position).add(new THREE.Vector3(0, 3, 9).applyQuaternion(playerModel.quaternion));
                else if (cameraMode === 2) camera.position.copy(playerModel.position).add(new THREE.Vector3(0, 20, 5).applyQuaternion(playerModel.quaternion));
                else if (cameraMode === 3) camera.position.copy(playerModel.position).add(new THREE.Vector3(0, 1.5, -9).applyQuaternion(playerModel.quaternion));
                camera.lookAt(playerModel.position.x, playerModel.position.y + 0.5, playerModel.position.z);
            }

            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
