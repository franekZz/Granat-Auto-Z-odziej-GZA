<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>GZA 1GB - Misja Rowerowa</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background: #000; }
        #ui {
            position: absolute; top: 20px; left: 20px; color: #ff00ff;
            text-shadow: 2px 2px #000; pointer-events: none; z-index: 10;
        }
        #mission-box {
            position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8);
            padding: 15px; border: 2px solid #ff00ff; color: #fff; width: 260px;
        }
        #speedometer {
            position: absolute; bottom: 20px; right: 20px; color: #ff00ff;
            font-size: 24px; font-weight: bold; text-shadow: 2px 2px #000;
        }
        #hp-bar-container {
            width: 200px; height: 15px; border: 2px solid #ff00ff; background: #300030;
            margin-top: 10px; border-radius: 5px; overflow: hidden;
        }
        #hp-bar-fill { width: 100%; height: 100%; background: #ff00ff; transition: width 0.2s; }
        #damage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0.4); display: none; pointer-events: none; z-index: 5;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            border: 2px solid #ff00ff; border-radius: 50%; transform: translate(-50%, -50%);
        }
        #instructions {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; background: rgba(0,0,0,0.95); z-index: 100; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="damage-overlay"></div>
    <div id="ui">
        <div style="font-weight: bold; font-size: 22px;">GZA: MISSION START</div>
        <div id="hp-bar-container"><div id="hp-bar-fill"></div></div>
        <div id="weapon-info" style="margin-top:5px;">BROŃ: PISTOLET</div>
    </div>

    <div id="mission-box">
        <b style="color: #ff00ff;">MISJA:</b><br>
        <span id="mission-text">Idź do czarnego budynku, aby rozpocząć zlecenie.</span>
    </div>

    <div id="speedometer">0 KM/H</div>
    <div id="crosshair"></div>

    <div id="instructions">
        <h1>GZA 1GB</h1>
        <p>KLIKNIJ, ABY ZACZĄĆ</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        let scene, camera, renderer, weapon, playerModel, bike, muzzleFlash;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, canJump = false;
        let velocity = new THREE.Vector3(), direction = new THREE.Vector3();
        let prevTime = performance.now();
        let npcs = [];
        let playerHP = 100, missionStep = 1, targetsKilled = 0;
        let isOnBike = false, cameraMode = 0;

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050005);
            scene.fog = new THREE.Fog(0x050005, 0, 600);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const sun = new THREE.PointLight(0xff00ff, 2, 800);
            sun.position.set(50, 100, 50);
            scene.add(sun);

            // Podłoga
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(5000, 5000), new THREE.MeshPhongMaterial({ color: 0x111111 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Budynek Bazy (Zlecenie)
            const base = new THREE.Mesh(new THREE.BoxGeometry(40, 30, 40), new THREE.MeshPhongMaterial({ color: 0x151515, side: THREE.DoubleSide }));
            base.position.set(0, 15, -80);
            scene.add(base);

            // Gracz
            playerModel = new THREE.Group();
            const pBody = new THREE.Mesh(new THREE.BoxGeometry(0.8, 2, 0.5), new THREE.MeshPhongMaterial({color: 0xff00ff}));
            const pHead = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshPhongMaterial({color: 0xffffff}));
            pHead.position.y = 1.3;
            playerModel.add(pBody, pHead);
            scene.add(playerModel);

            // Broń (Tylko FPP)
            weapon = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.15, 0.7), new THREE.MeshPhongMaterial({color: 0x222222}));
            weapon.position.set(0.4, -0.4, -0.6);
            camera.add(weapon);
            scene.add(camera);

            // Cele (Zła Dzielnica)
            createNPC(250, 250, true);
            createNPC(260, 240, true);
            const redLight = new THREE.PointLight(0xff0000, 10, 150);
            redLight.position.set(250, 15, 250);
            scene.add(redLight);

            // Start
            const inst = document.getElementById('instructions');
            inst.addEventListener('click', () => { document.body.requestPointerLock(); inst.style.display = 'none'; });

            document.addEventListener('keydown', (e) => {
                if(e.code === 'KeyW') moveForward = true;
                if(e.code === 'KeyS') moveBackward = true;
                if(e.code === 'KeyA') moveLeft = true;
                if(e.code === 'KeyD') moveRight = true;
                if(e.code === 'KeyV') cameraMode = (cameraMode + 1) % 4;
                if(e.code === 'Space' && canJump) { velocity.y += 15; canJump = false; }
            });
            document.addEventListener('keyup', (e) => {
                if(e.code === 'KeyW') moveForward = false;
                if(e.code === 'KeyS') moveBackward = false;
                if(e.code === 'KeyA') moveLeft = false;
                if(e.code === 'KeyD') moveRight = false;
            });
            document.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement === document.body) {
                    playerModel.rotation.y -= e.movementX * 0.002;
                    camera.rotation.x -= e.movementY * 0.002;
                    camera.rotation.x = Math.max(-0.7, Math.min(0.7, camera.rotation.x));
                }
            });

            window.addEventListener('mousedown', () => {
                if (document.pointerLockElement !== document.body) return;
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera({x: 0, y: 0}, camera);
                const intersects = raycaster.intersectObjects(npcs, true);
                if (intersects.length > 0) {
                    let target = intersects[0].object.parent;
                    if (intersects[0].distance < 100) {
                        target.userData.hp -= 50;
                        target.userData.aggro = true;
                        if(target.userData.hp <= 0 && target.userData.isTarget) targetsKilled++;
                    }
                }
            });
        }

        function spawnBike() {
            bike = new THREE.Group();
            const frame = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.8, 1.8), new THREE.MeshPhongMaterial({color: 0xcccccc}));
            const w1 = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.05, 8, 24), new THREE.MeshPhongMaterial({color: 0x444444}));
            w1.position.z = 0.8; w1.rotation.y = Math.PI/2;
            const w2 = w1.clone(); w2.position.z = -0.8;
            bike.add(frame, w1, w2);
            bike.position.set(0, 0.5, -80);
            scene.add(bike);
        }

        function createNPC(x, z, isTarget) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.2, 1), new THREE.MeshPhongMaterial({color: isTarget?0xff0000:0x00ff88}));
            group.add(body);
            group.position.set(x, 1.1, z);
            group.userData = { hp: 100, aggro: isTarget, lastShot: 0, isTarget: isTarget };
            scene.add(group);
            npcs.push(group);
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            // Logika Misji - Rower pojawia się dopiero po wejściu
            if (missionStep === 1 && playerModel.position.distanceTo(new THREE.Vector3(0, 0, -80)) < 12) {
                spawnBike();
                missionStep = 2; 
                document.getElementById('mission-text').innerText = "Rower dostarczony! Zabierz go.";
            }
            if (missionStep === 2 && bike && playerModel.position.distanceTo(bike.position) < 3) {
                isOnBike = true; missionStep = 3; 
                document.getElementById('mission-text').innerText = "Jedź do Złej Dzielnicy (250, 250).";
            }
            if (missionStep === 3 && playerModel.position.distanceTo(new THREE.Vector3(250, 0, 250)) < 50) {
                missionStep = 4;
            }
            if (missionStep === 4) {
                document.getElementById('mission-text').innerText = "Zabij czerwonych. Postęp: " + targetsKilled + "/2";
                if(targetsKilled >= 2) document.getElementById('mission-text').innerText = "MISJA WYKONANA!";
            }

            // Ruch
            let speedLimit = isOnBike ? 900 : 400;
            velocity.y -= 9.8 * 4.0 * delta;
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;

            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            if (moveForward || moveBackward) velocity.z -= direction.z * speedLimit * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * speedLimit * delta;

            const moveVec = new THREE.Vector3(-velocity.x * delta, 0, velocity.z * delta).applyQuaternion(playerModel.quaternion);
            playerModel.position.add(moveVec);
            playerModel.position.y += velocity.y * delta;

            if (playerModel.position.y < 1.1) { velocity.y = 0; playerModel.position.y = 1.1; canJump = true; }

            // Speedometer
            let currentSpeed = Math.round(Math.abs(velocity.z / 10));
            document.getElementById('speedometer').innerText = currentSpeed + " KM/H";

            if(isOnBike) { bike.position.copy(playerModel.position); bike.rotation.y = playerModel.rotation.y; }

            // Kamery i Widoczność Broni (USUNIĘTA RĘKA Z TPP)
            if (cameraMode === 0) { // FPP
                camera.position.copy(playerModel.position).y += 0.8;
                camera.rotation.y = playerModel.rotation.y;
                playerModel.visible = false;
                weapon.visible = true; 
                document.getElementById('crosshair').style.display = 'block';
            } else {
                playerModel.visible = true;
                weapon.visible = false; 
                document.getElementById('crosshair').style.display = 'none';
                if (cameraMode === 1) camera.position.copy(playerModel.position).add(new THREE.Vector3(0, 3, 7).applyQuaternion(playerModel.quaternion));
                else if (cameraMode === 2) camera.position.copy(playerModel.position).add(new THREE.Vector3(0, 15, 5).applyQuaternion(playerModel.quaternion));
                else if (cameraMode === 3) camera.position.copy(playerModel.position).add(new THREE.Vector3(0, 1.5, -8).applyQuaternion(playerModel.quaternion));
                camera.lookAt(playerModel.position.x, playerModel.position.y + 0.5, playerModel.position.z);
            }

            npcs.forEach(npc => {
                if (npc.userData.hp > 0 && npc.userData.aggro) {
                    npc.lookAt(playerModel.position.x, 1.1, playerModel.position.z);
                    if (time - npc.userData.lastShot > 1600 && playerModel.position.distanceTo(npc.position) < 40) {
                        playerHP -= 8;
                        document.getElementById('hp-bar-fill').style.width = playerHP + "%";
                        document.getElementById('damage-overlay').style.display = 'block';
                        setTimeout(() => document.getElementById('damage-overlay').style.display = 'none', 100);
                        npc.userData.lastShot = time;
                    }
                }
            });

            if(playerHP <= 0) location.reload();
            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
